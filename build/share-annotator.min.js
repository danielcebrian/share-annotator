var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Share=(function(b){__extends(a,b);a.prototype.options={shareIn:["facebook","twitter","email","google"],getUrl:{facebook:function(e,d,c){return"https://www.facebook.com/sharer/sharer.php?s=100&p[url]="+d+"&p[title]="+encodeURIComponent("Open Video Annotation")+"&p[summary]="+c},twitter:function(e,d,c){return"https://twitter.com/intent/tweet?original_referer="+d+"&source=tweetbutton&url="+d+"&via=OpenVideoAnnotation&text="+encodeURIComponent("I want to share the next Open Video Annotation: ")},google:function(e,d,c){return"https://plus.google.com/share?url="+d},email:function(e,d,c){return"mailto:?subject="+e+"&body="+d}},baseUrl:"",};function a(d,c){if(typeof c!="undefined"){this.options.shareIn=typeof c.shareIn!="undefined"?c.shareIn:this.options.shareIn}this.buildHTMLShareButton=__bind(this.buildHTMLShareButton,this);this.runningAPI=__bind(this.runningAPI,this);this.updateViewer=__bind(this.updateViewer,this);_ref=a.__super__.constructor.apply(this,arguments);return _ref}a.prototype.field=null;a.prototype.input=null;a.prototype.pluginInit=function(){console.log("Share-pluginInit");if(!Annotator.supported()){return}this.field=this.annotator.editor.addField({type:"input",});var d=Annotator.$('<li class="annotator-item">'+this.buildHTMLShareButton("Share without saving:")+"</li>");Annotator.$(this.field).replaceWith(d);this.field=d[0];this.buttonsActions(this.field,2,this.options.baseUrl);var e=this.initAPI();this.runAPI(e);var c=this.annotator.viewer.addField({load:this.updateViewer,});return this.input=$(this.field).find(":input")};a.prototype.buildHTMLShareButton=function(f,g){var f=f||"",g=typeof g!="undefined"?'annotationId="'+g+'"':"",d=f!=""?'<div class="share-text-annotator">'+f+"</div>":"",e='<div class="share-button-annotator share-button" '+g+"></div>",c='<div class="share-popup-overlay-bg" style="z-index:30000000000"><div class="share-popup"><div class="share-popup-items"></div><div class="close-btn">Close</div></div></div>';return'<div class="share-container-annotator">'+d+e+c+"</div>"};a.prototype.buildHTMLPopup=function(f){var e="";if(typeof this.options.shareIn!="undefined"){this.options.shareIn.forEach(function(h){e+='<div class="share-'+h+'-annotator share-button">'+h.charAt(0).toUpperCase()+h.slice(1)+"</div>"})}this.uri=typeof this.uri!="undefined"?this.uri:"";var f='<div class="share-popup-title">'+f.replace(":","")+"</div>",g='<div class="share-popup-copy">Copy and Share:</div>',d='<input type="text" class="share-popup-uri" onclick="javascript:this.select();" readonly="true" value="'+this.uri+'">',c=f+e+g+d;return c};a.prototype.buttonsActions=function(e,f,c){var d=this;$(e).find(".close-btn").click(function(){$(".share-popup-overlay-bg").hide()});$(e).find(".share-popup-overlay-bg").click(function(){$(".share-popup-overlay-bg").hide()});$(e).find(".share-popup").click(function(){return false});$(e).find(".share-button-annotator.share-button").click(function(event){event.preventDefault();var h=this,g=$(this).attr("annotationId"),i=f==1?"Share":"Share without saving";d.uri=d.createAPIURL(f,g,c);$(this).parent().find(".share-popup-overlay-bg").show();$(this).parent().find(".share-popup-items").html(d.buildHTMLPopup(i));if(typeof d.options.shareIn!="undefined"){d.options.shareIn.forEach(function(j){$(h).parent().find(".share-"+j+"-annotator.share-button").click(function(){var l=d.createAPIURL(f,g,l),n="Sharing a annotation with Open Video Annotation";link=encodeURIComponent(l),noteText=d.getSource("ovaText"),finalUrl="";if(f==1){var m=d.annotator.viewer,k=$(m.element).find("div:first").html();noteText=encodeURIComponent(k)}finalUrl=typeof d.options.getUrl[j]!="undefined"?d.options.getUrl[j](n,link,noteText):"";if(typeof d.options.getUrl[j]!="undefined"){window.open(finalUrl)}})})}})};a.prototype.createAPIURL=function(f,k,h){var q=this.annotator,g=q.editor,f=f||1,h=h||window.location.href;h+=(h.indexOf("?")>=0)?"&":"?";if(f===1){var k=typeof k!="undefined"?k:"";h+="ovaId="+k}else{if(f===2){var u=this.getSource("ovaText")||" ";h+="ovaText="+u;if(typeof g.VideoJS!="undefined"&&g.VideoJS!==-1){var d=this.getSource("ovaStart")||" ",j=this.getSource("ovaEnd")||" ",t=this.getSource("ovaContainer")||" ",l=this.getSource("ovaSrc")||" ";h+="&ovaStart="+d+"&ovaEnd="+j+"&ovaContainer="+t+"&ovaSrc="+l}else{if(typeof g.OpenSeaDragon!="undefined"&&g.OpenSeaDragon!==-1){var p=this.getSource("ovaLeft")||" ",s=this.getSource("ovaTop")||" ",n=this.getSource("ovaWidth")||" ",c=this.getSource("ovaHeight")||" ",v=this.getSource("ovaLeftZoom")||" ",r=this.getSource("ovaTopZoom")||" ",i=this.getSource("ovaWidthZoom")||" ",m=this.getSource("ovaHeightZoom")||" ",t=this.getSource("ovaContainer")||" ",l=this.getSource("ovaSrc")||" ";h+="&ovaLeft="+p+"&ovaTop="+s+"&ovaWidth="+n+"&ovaHeight="+c+"&ovaLeftZoom="+v+"&ovaTopZoom="+r+"&ovaWidthZoom="+i+"&ovaHeightZoom="+m+"&ovaContainer="+t+"&ovaSrc="+l}else{var d=this.getSource("ovaStart")||" ",j=this.getSource("ovaEnd")||" ",e=this.getSource("ovastartOffset")||" ",o=this.getSource("ovaendOffset")||" ";h+="&ovaStart="+d+"&ovaEnd="+j+"&ovastartOffset="+e+"&ovaendOffset="+o}}}}return h};a.prototype.getSource=function(h){var h=h||"";if(h=="ovaId"){h=this.annotation.id}else{var i=this.annotator,g=i.editor,e=$(g.element).find("textarea")[0];if(h=="ovaText"){h=e.value}if(typeof g.VideoJS!="undefined"&&g.VideoJS!==-1){if(h=="ovaContainer"){h=g.VideoJS}else{if(h=="ovaSrc"){h=i.mplayer[g.VideoJS].tech.options_.source.src}else{if(h=="ovaStart"){h=i.mplayer[g.VideoJS].rangeslider.getValues().start}else{if(h=="ovaEnd"){h=i.mplayer[g.VideoJS].rangeslider.getValues().end}}}}}else{if(typeof g.OpenSeaDragon!="undefined"&&g.OpenSeaDragon!==-1){var c=g.annotation;if(h=="ovaLeft"){h=i.osda.rectPosition.left}else{if(h=="ovaTop"){h=i.osda.rectPosition.top}else{if(h=="ovaWidth"){h=i.osda.rectPosition.width}else{if(h=="ovaHeight"){h=i.osda.rectPosition.height}else{if(h=="ovaLeftZoom"){h=i.osda.viewer.drawer.viewport.getBounds().x}else{if(h=="ovaTopZoom"){h=i.osda.viewer.drawer.viewport.getBounds().y}else{if(h=="ovaWidthZoom"){h=i.osda.viewer.drawer.viewport.getBounds().width}else{if(h=="ovaHeightZoom"){h=i.osda.viewer.drawer.viewport.getBounds().height}else{if(h=="ovaContainer"){h=i.osda.viewer.id}else{if(h=="ovaSrc"){var h=i.osda.viewer.source,d=typeof h.tilesUrl!="undefined"?h.tilesUrl:"",f=typeof h.getTileUrl!="undefined"?h.getTileUrl:"";h=d!=""?d:(""+f).replace(/\s+/g," ")}}}}}}}}}}}else{var c=g.annotation;if(h=="ovastartOffset"){h=c.ranges[0].startOffset}else{if(h=="ovaendOffset"){h=c.ranges[0].endOffset}else{if(h=="ovaStart"){h=c.ranges[0].start}else{if(h=="ovaEnd"){h=c.ranges[0].end}}}}}}}return encodeURIComponent(h)};a.prototype.initAPI=function(){console.log("initAPI");var o={},i=this.getParameterByName("ovaId"),e=this.getParameterByName("ovaStart"),d=this.getParameterByName("ovaEnd"),m=this.getParameterByName("ovaContainer"),h=this.getParameterByName("ovaSrc"),n=this.getParameterByName("ovaText"),u=this.getParameterByName("ovaUser"),j=this.getParameterByName("ovaLeft"),q=this.getParameterByName("ovaTop"),r=this.getParameterByName("ovaWidth"),l=this.getParameterByName("ovaHeight"),f=this.getParameterByName("ovaLeftZoom"),k=this.getParameterByName("ovaTopZoom"),s=this.getParameterByName("ovaWidthZoom"),t=this.getParameterByName("ovaHeightZoom"),p=this.getParameterByName("ovastartOffset"),g=this.getParameterByName("ovaendOffset");var c=top.location.href;if(i!=""){c=this.removeVariableFromURL(c,"ovaId")}if(e!=""){c=this.removeVariableFromURL(c,"ovaStart")}if(d!=""){c=this.removeVariableFromURL(c,"ovaEnd")}if(m!=""){c=this.removeVariableFromURL(c,"ovaContainer")}if(h!=""){c=this.removeVariableFromURL(c,"ovaSrc")}if(n!=""){c=this.removeVariableFromURL(c,"ovaText")}if(u!=""){c=this.removeVariableFromURL(c,"ovaUser")}if(j!=""){c=this.removeVariableFromURL(c,"ovaLeft")}if(q!=""){c=this.removeVariableFromURL(c,"ovaTop")}if(r!=""){c=this.removeVariableFromURL(c,"ovaWidth")}if(l!=""){c=this.removeVariableFromURL(c,"ovaHeight")}if(f!=""){c=this.removeVariableFromURL(c,"ovaLeftZoom")}if(k!=""){c=this.removeVariableFromURL(c,"ovaTopZoom")}if(s!=""){c=this.removeVariableFromURL(c,"ovaWidthZoom")}if(t!=""){c=this.removeVariableFromURL(c,"ovaHeightZoom")}if(p!=""){c=this.removeVariableFromURL(c,"ovastartOffset")}if(g!=""){c=this.removeVariableFromURL(c,"ovaendOffset")}window.history.pushState("object or string","Title",c);if(i!=""){$.extend(o,{method:1,ovaId:i})}if(e!=""&&d!=""&&m!=""&&h!=""){$.extend(o,{method:2,start:e,end:d,container:m,src:h,text:n,user:u})}else{if(j!=""&&q!=""&&r!=""&&l!=""&&f!=""&&k!=""&&s!=""&&t!=""){$.extend(o,{method:2,Left:j,Top:q,Width:r,Height:l,leftZoom:f,topZoom:k,widthZoom:s,heightZoom:t,container:m,src:h,text:n,user:u})}else{if(e!=""&&d!=""&&p!=""&&g!=""){$.extend(o,{method:2,start:e,end:d,startOffset:p,endOffset:g,text:n,user:u})}}}return o};a.prototype.runningAPI=function(c,x){var l=$(".annotator-wrapper").parent()[0],h,e,v=this;$.data(l,"annotator",v.annotator);annotator=window.annotator=$.data(l,"annotator");h=typeof annotator.mplayer!="undefined"?annotator.mplayer:[];e=typeof annotator.osda!="undefined"?annotator.osda:[];if(typeof x!="undefined"&&typeof x.method!="undefined"&&(x.method=="1"||x.method=="2")){if(x.method=="1"){var o=annotator.plugins.Store.annotations,q=decodeURIComponent(x.ovaId);for(var D in o){var z=o[D],w;if(typeof z.id!="undefined"&&z.id==q){if(v._isVideo(z)){if(typeof h[z.target.container]!="undefined"){var A=h[z.target.container];if(A.id_==z.target.container){var J=z;videojs(A.id_).ready(function(){if(A.techName!="Youtube"){A.preload("auto")}A.autoPlayAPI=J;A.play()})}}}else{if(z.media=="image"){if($("div#"+z.target.container).length){var f=typeof annotator.osda!="undefined"&&typeof annotator.osda.viewer!="undefined";function H(){f=typeof annotator.osda!="undefined"&&typeof annotator.osda.viewer!="undefined";if(typeof w=="undefined"){w=D}if(!f){setTimeout(H,200)}else{z=o[w];$(z.highlights).parent().find(".annotator-hl").removeClass("api");$(z.highlights).addClass("api");if(typeof annotator!="undefined"&&typeof annotator.osda!="undefined"){var K=annotator.osda.viewer.drawer.viewport.getBounds(),L=typeof z.bounds!="undefined"?z.bounds:{};if(typeof L.x!="undefined"){K.x=L.x}if(typeof L.y!="undefined"){K.y=L.y}if(typeof L.width!="undefined"){K.width=L.width}if(typeof L.height!="undefined"){K.height=L.height}annotator.osda.viewer.drawer.viewport.fitBounds(K)}$("html,body").animate({scrollTop:$(annotator.osda.viewer.element).offset().top},"slow")}}H()}}else{var y=typeof z.ranges!="undefined"&&typeof z.ranges[0]!="undefined",B=y?z.ranges[0].startOffset:"",k=y?z.ranges[0].endOffset:"";if(typeof B!="undefined"&&typeof k!="undefined"){$(z.highlights).addClass("api");$("html,body").animate({scrollTop:$(z.highlights[0]).offset().top},"slow")}}}}}}else{if(x.method=="2"){if(typeof h!="undefined"){var t=decodeURIComponent(x.container),A=h[t],F=(typeof A!="undefined"&&t==A.id_),u=(!isNaN(parseFloat(x.start))&&isFinite(x.start)&&!isNaN(parseFloat(x.end))&&isFinite(x.end)),d=false;if(F){var n=decodeURIComponent(x.src),g=n.substring(0,n.lastIndexOf(".")),m=A.tech.options_.source.src==""?A.tag.currentSrc:A.tech.options_.source.src;m=m.substring(0,m.lastIndexOf("."));d=(g==m)}if(F&&u&&d){var j={rangeTime:{start:x.start,end:x.end},created:new Date().toISOString(),updated:new Date().toISOString(),target:{container:t,src:n},media:"video",text:decodeURIComponent(x.text),user:decodeURIComponent(x.user)};videojs(A.id_).ready(function(){if(A.techName!="Youtube"){A.preload("auto")}A.autoPlayAPI=j;A.play()})}}var B=x.startOffset,k=x.endOffset;if(!F&&typeof B!="undefined"&&typeof k!="undefined"){var j={ranges:[{start:decodeURIComponent(x.start),end:decodeURIComponent(x.end),startOffset:decodeURIComponent(x.startOffset),endOffset:decodeURIComponent(x.endOffset),}],created:new Date().toISOString(),updated:new Date().toISOString(),media:"text",text:decodeURIComponent(x.text),user:decodeURIComponent(x.user)};annotator.setupAnnotation(j);$(j.highlights).addClass("api");$("html,body").animate({scrollTop:$(j.highlights[0]).offset().top},"slow")}var p=x.Left,C=x.Top,E=x.Width,s=x.Height,i=x.leftZoom,r=x.topZoom,G=x.widthZoom,I=x.heightZoom;if(!F&&typeof p!="undefined"&&typeof C!="undefined"&&typeof E!="undefined"&&typeof s!="undefined"&&typeof i!="undefined"&&typeof r!="undefined"&&typeof G!="undefined"&&typeof I!="undefined"){var z={rangePosition:{width:parseFloat(decodeURIComponent(x.Width)),top:parseFloat(decodeURIComponent(x.Top)),left:parseFloat(decodeURIComponent(x.Left)),height:parseFloat(decodeURIComponent(x.Height)),},bounds:{width:parseFloat(decodeURIComponent(x.widthZoom)),x:parseFloat(decodeURIComponent(x.leftZoom)),y:parseFloat(decodeURIComponent(x.topZoom)),height:parseFloat(decodeURIComponent(x.heightZoom)),},target:{container:x.container,src:x.src},created:new Date().toISOString(),updated:new Date().toISOString(),media:"image",text:decodeURIComponent(x.text),user:decodeURIComponent(x.user)};var f=typeof annotator.osda!="undefined"&&typeof annotator.osda.viewer!="undefined";function H(){f=typeof annotator.osda!="undefined"&&typeof annotator.osda.viewer!="undefined";if(!f){setTimeout(H,200)}else{annotator.plugins.Store.annotations.push(z);annotator.osda.viewer.annotationInstance.drawRect(z);$(z.highlights).addClass("api");var K=annotator.osda.viewer.drawer.viewport.getBounds(),L=typeof z.bounds!="undefined"?z.bounds:{};if(typeof L.x!="undefined"){K.x=L.x}if(typeof L.y!="undefined"){K.y=L.y}if(typeof L.width!="undefined"){K.width=L.width}if(typeof L.height!="undefined"){K.height=L.height}annotator.osda.viewer.drawer.viewport.fitBounds(K);$("html,body").animate({scrollTop:$(annotator.osda.viewer.element).offset().top},"slow")}}H()}}}}annotator.isShareLoaded=true;annotator.publish("shareloaded")};a.prototype.runAPI=function(d){var c=this;var e=function(f){c.runningAPI(f,d);c.annotator.unsubscribe("annotationsLoaded",e)};this.annotator.subscribe("annotationsLoaded",e)};a.prototype._isVideo=function(c){var c=c||{};rt=c.rangeTime,isVideo=(typeof c.media!="undefined"&&c.media=="video"),hasContainer=(typeof c.target!="undefined"&&typeof c.target.container!="undefined"),isNumber=(typeof rt!="undefined"&&!isNaN(parseFloat(rt.start))&&isFinite(rt.start)&&!isNaN(parseFloat(rt.end))&&isFinite(rt.end));return(isVideo&&hasContainer&&isNumber)};a.prototype._isImage=function(g){var j=$(".annotator-wrapper").parent()[0],i=window.annotator=$.data(j,"annotator"),f=g.rangePosition,d=(typeof i.osda!="undefined"),e=(typeof g.target!="undefined"&&typeof g.target.container!="undefined"),h=(typeof g.media!="undefined"&&g.media=="image"),c=(typeof f!="undefined");return(d&&e&&h&&c)};a.prototype.getParameterByName=function(c){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+c+"=([^&#]*)"),d=e.exec("?"+window.location.href.split("?")[1]);return d==null?"":decodeURIComponent(d[1].replace(/\+/g," "))};a.prototype.removeVariableFromURL=function(f,d){var c=String(f);var e=new RegExp("\\?"+d+"=[^&]*&?","gi");c=c.replace(e,"?");e=new RegExp("\\&"+d+"=[^&]*&?","gi");c=c.replace(e,"&");c=c.replace(/(\?|&)$/,"");e=null;return c};a.prototype.updateViewer=function(f,c){this.annotation=c;var d=this,f=$(f),e=f.addClass("share-viewer-annotator").html(function(){var g;return d.buildHTMLShareButton("Share:",d.getSource("ovaId"))});this.buttonsActions(f[0],1,this.options.baseUrl);return e};return a})(Annotator.Plugin);
