// Generated by CoffeeScript 1.6.3
var _ref,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Annotator.Plugin.Share = (function(_super) {
	__extends(Share, _super);

	function Share() {
		_ref = Share.__super__.constructor.apply(this, arguments);
		return _ref;
	}

	Share.prototype.field = null;

	Share.prototype.input = null;

	Share.prototype.pluginInit = function() {
		console.log("Share-pluginInit");
		//Check that annotator is working
		if (!Annotator.supported()) {
			return;
		}
		
		//-- Editor
		this.field = this.annotator.editor.addField({
			type: 'input', //options (textarea,input,select,checkbox)
		});
		
		//Modify the element created with annotator to be an invisible span
		var newfield = Annotator.$('<li class="annotator-item">'+this.buildHTML('Share without saving:')+'</li>');
		Annotator.$(this.field).replaceWith(newfield);
		this.field=newfield[0];
		
		//Create the actions for the buttons
		this.buttonsActions(this.field,2); //2 is the method of the API that will be for share without saving
		
		//Init the API plugin
		var APIoptions = this.initAPI();
		
		this.runAPI(APIoptions);
		
		//-- Viewer
		var newview = this.annotator.viewer.addField({
			load: this.updateViewer,
      		buildHTML: this.buildHTML,
      		buttonsActions: this.buttonsActions,
      		createAPIURL: this.createAPIURL,
      		annotator: this.annotator,
      		getSource: this.getSource,
		});

		return this.input = $(this.field).find(':input');
	};
	
	//template for the design of the Share Plugin
	Share.prototype.buildHTML = function(title) {
		var title = title || 'Share:';
			titleText = '<div class="share-text-annotator">'+title+'</div>',
			facebook = '<div class="share-facebook-annotator share-button"></div>',
			twitter = '<div class="share-twitter-annotator share-button"></div>',
			google = '<div class="share-google-annotator share-button"></div>',
			email = '<div class="share-email-annotator share-button"></div>',
			buttons = facebook + twitter + google + email;
		return '<div class="share-container-annotator">'+titleText+buttons+'</div>';
			
	}
	
	//Create the actions for the buttons
	Share.prototype.buttonsActions = function(field,method) {
		var share = this;
		$(field).find('.share-email-annotator').click(function() {
			var url = share.createAPIURL(method),
				subject = "Sharing a annotation with Open Video Annotation";
				body = encodeURIComponent(url);
			
			window.open('mailto:?subject='+subject+'&body='+body);
		});
		$(field).find('.share-facebook-annotator').click(function() {
			var url = share.createAPIURL(method),
				fbURL = 'https://www.facebook.com/sharer/sharer.php?s=100&p[url]='+encodeURIComponent(url)+'&p[title]='+encodeURIComponent('Open Video Annotation')+'&p[summary]='+share.getSource('ovaText');
			
			window.open(fbURL);
		});
		$(field).find('.share-twitter-annotator').click(function() {
			var url = share.createAPIURL(method),
				twitterURL = 'https://twitter.com/intent/tweet?original_referer='+encodeURIComponent(url)+'&source=tweetbutton&url='+encodeURIComponent(url)+ "&via=OpenVideoAnnotation&text=" +encodeURIComponent('I want to share the next Open Video Annotation: ');
			window.open(twitterURL);
		});
		$(field).find('.share-google-annotator').click(function() {
			var url = share.createAPIURL(method),
				googleURL = 'https://plus.google.com/share?url='+encodeURIComponent(url);
			window.open(googleURL);
		});
	};
	
	
	Share.prototype.createAPIURL = function(method) {
		var annotator = this.annotator,
			editor = annotator.editor,
			method = method || 1,
			//url = location.protocol + '//' + location.host + location.pathname,
			url = window.location.href;
			
		if(url.indexOf('?') >= 0)
			url += '&';
		else
			url += '?';
			
		if (method === 1){
			var ovaId = this.getSource('ovaId');
			url += 'ovaId=' + ovaId;
		}else if (method === 2){
			var ovaStart = this.getSource('ovaStart'),
				ovaEnd = this.getSource('ovaEnd'),
				ovaText = this.getSource('ovaText');
			url += 'ovaStart='+ ovaStart
					+'&ovaEnd='+ ovaEnd
					+'&ovaText='+ ovaText;
			if(typeof editor.VideoJS!='undefined' && editor.VideoJS !== -1){//Video Annotation
				var	ovaContainer = this.getSource('ovaContainer'),
					ovaSrc = this.getSource('ovaSrc');
				url += '&ovaContainer='+ovaContainer
					+'&ovaSrc='+ ovaSrc;
			}else{//Text Annotation
				var	ovastartOffset = this.getSource('ovastartOffset'),
					ovaendOffset = this.getSource('ovaendOffset');
				url += '&ovastartOffset='+ovastartOffset
					+'&ovaendOffset='+ ovaendOffset;
			}
		}
		return url;
	};
	
	Share.prototype.getSource = function(source) {
		var	source = source || '';
		if (source == 'ovaId') {//method 1
			var annotator = this.annotator,
				viewer = annotator.viewer,
				textarea = $(viewer.element).find('textarea')[0];
			source=this.annotation.id;
		}else{//method 2
			var annotator = this.annotator,
				editor = annotator.editor,
				textarea = $(editor.element).find('textarea')[0];
			
			if(source == 'ovaText')
				source = textarea.value;
			if (typeof editor.VideoJS!='undefined' && editor.VideoJS !== -1){//Video Annotation
				if(source == 'ovaContainer')
					source = editor.VideoJS;
				else if(source == 'ovaSrc')
					source = annotator.mplayer[editor.VideoJS].tag.currentSrc;
				else if(source == 'ovaStart')
					source = annotator.mplayer[editor.VideoJS].rangeslider.getValues().start;
				else if(source == 'ovaEnd')
					source = annotator.mplayer[editor.VideoJS].rangeslider.getValues().end;
		
			}else{//Text Annotation
				var annotation = editor.annotation;
				if(source == 'ovastartOffset')
					source = annotation.ranges[0].startOffset;
				else if(source == 'ovaendOffset')
					source = annotation.ranges[0].endOffset;
				else if(source == 'ovaStart')
					source = annotation.ranges[0].start;
				else if(source == 'ovaEnd')
					source = annotation.ranges[0].end;
			}
		}
		return encodeURIComponent(source);
	};
	
	Share.prototype.initAPI = function() {
		console.log("initAPI");
		// -- Detect API in the URL -- //
		/*
		The first option is to give a known id of an annotation
		Example http://url.com/#id=rTcpOjIMT2aF1apDtboC-Q
		*/
		var API = {},
			ovaId = this.getParameterByName('ovaId'), //Method 1 (Obligatory)
			start = this.getParameterByName('ovaStart'), //Method 2 (Obligatory)
			end = this.getParameterByName('ovaEnd'), //Method 2 (Obligatory)
			container = this.getParameterByName('ovaContainer'), //Method 2 (Obligatory)
			src = this.getParameterByName('ovaSrc'),//Method 2 (Obligatory)
			text = this.getParameterByName('ovaText'),//Method 2 
			user = this.getParameterByName('ovaUser'),//Method 2 
			startOffset = this.getParameterByName('ovastartOffset'),//Method 2 
			endOffset = this.getParameterByName('ovaendOffset');//Method 2 
		
		// Method 1 API with the Id of the annotation
		//Example: http://danielcebrian.com/annotations/demo.html?&ovaId=wtva_SjnQb2HtqppDihKug
		if(ovaId != ''){
			$.extend(API,{method:1,ovaId:ovaId});
		}
		//Method 2 API with all the parameter to load the annotation
		//Example with video: http://danielcebrian.com/annotations/demo.html?ovaContainer=vid1&ovaSrc=http%3A%2F%2Fvideo-js.zencoder.com%2Foceans-clip.mp4&ovaStart=2&ovaEnd=10&ovaText=This%20is%20test&ovaUser=Test%20User
		//Example with text: http://danielcebrian.com/annotations/demo.html?ovaStart=%2Fp%5B1%5D&ovaEnd=%2Fp%5B1%5D&ovastartOffset=542&ovaendOffset=572&ovaText=API
	
		if(start!='' && end!='' && container!='' && src!=''){//video api
			$.extend(API,{method:2,start:start,end:end,container:container,src:src,text:text,user:user});
		}else if(start!='' && end!='' && startOffset!='' && endOffset!=''){//text api
			$.extend(API,{method:2,start:start,end:end,startOffset:startOffset,endOffset:endOffset,text:text,user:user});
		}
		return API;
	}
	
	Share.prototype.runAPI = function(API) {
		var self = this;
		this.annotator
			//-- Finished the Annotator DOM
			.subscribe("annotationsLoaded", function (annotations){
				console.log("runningAPI");
				var wrapper = $('.annotator-wrapper').parent()[0],
					mplayer;
					
				//Set Annotator in wrapper to fix quick DOM
				$.data(wrapper, 'annotator', self.annotator);//Set the object in the span
				annotator = window.annotator = $.data(wrapper, 'annotator');
				mplayer = typeof annotator.mplayer!='undefined'?annotator.mplayer:[];
				
				//Detect if the URL has an API element
				if (typeof API!='undefined' && typeof API.method!='undefined' && (API.method=='1'||API.method=='2')) {
					if(API.method=='1'){
						var allannotations = annotator.plugins['Store'].annotations,
							ovaId = decodeURIComponent(API.ovaId);
						
						for (var item in allannotations) {
							var an = allannotations[item];
							if (typeof an.id!='undefined' && an.id == ovaId){//this is the annotation
								if(self._isVideo(an)){//It is a video
									for (var index in mplayer){
										var player = mplayer[index];
										if (player.id_ == an.target.container){
											var anFound = an;
											videojs(player.id_).ready(function(){
												if (player.techName != 'Youtube'){
													player.preload('auto');
												}
												player.autoPlayAPI = anFound;
												player.play();
											});
										}
									}
								}else{//It is a text
									var hasRanges = typeof an.ranges!='undefined' && typeof an.ranges[0] !='undefined',
										startOffset = hasRanges?an.ranges[0].startOffset:'',
										endOffset = hasRanges?an.ranges[0].endOffset:'';
						
									if(typeof startOffset!='undefined' && typeof endOffset!='undefined'){ 
										//change the color
										$(an.highlights).addClass('api'); 
										//animate to the annotation
										$('html,body').animate({
											scrollTop: $(an.highlights[0]).offset().top},
											'slow');
									}
								}
							}
						}
					}else if (API.method=='2'){
						if (typeof mplayer!='undefined'){
							//variable for Video
							var	container = decodeURIComponent(API.container),
								player = mplayer[container],
								isVideo = (typeof player!='undefined' && container==player.id_),
								isNumber = (!isNaN(parseFloat(API.start)) && isFinite(API.start) && !isNaN(parseFloat(API.end)) && isFinite(API.end)),
								isSource = false;
								
							if(isVideo){
								//Compare without extension
								var src = decodeURIComponent(API.src),
									targetSrc = src.substring(0,src.lastIndexOf(".")),
									playerSrc = player.tag.src==''?player.tag.currentSrc:player.tag.src;
								playerSrc = playerSrc.substring(0,playerSrc.lastIndexOf("."))
								isSource = (targetSrc == playerSrc);
							}
				
							//Open Video Annotation
							if(isVideo && isNumber && isSource){ 
								var annotation = {
										rangeTime: {
											start:API.start,
											end:API.end
										},
										created: new Date().toISOString(),
										updated: new Date().toISOString(),
										target:{
											container: container,
											src: src
										},
										media: 'video',
										text:decodeURIComponent(API.text),
										user:decodeURIComponent(API.user)
									};
								videojs(player.id_).ready(function(){
									player.preload('auto');
									player.play();
									player.autoPlayAPI = annotation;
								});
							}
						}
						//variable for text
						var startOffset = API.startOffset,
							endOffset = API.endOffset;
						
						//Text Annotation
						if(!isVideo && typeof startOffset!='undefined' && typeof endOffset!='undefined'){ 
							var annotation = {
								ranges: [{
									start:decodeURIComponent(API.start),
									end:decodeURIComponent(API.end),
									startOffset:decodeURIComponent(API.startOffset),
									endOffset:decodeURIComponent(API.endOffset),
								}],
								created: new Date().toISOString(),
								updated: new Date().toISOString(),
								media: 'text',
								text:decodeURIComponent(API.text),
								user:decodeURIComponent(API.user)
							};
							//show the annotation
							annotator.setupAnnotation(annotation);
							//to change the color
							$(annotation.highlights).addClass('api'); 
							//animate to the annotation
							$('html,body').animate({
								scrollTop: $(annotation.highlights[0]).offset().top},
								'slow');
						}
						
					}
				}
				//Let know to others API that this plugin is loaded
				annotator.isShareLoaded = true;
				annotator.publish('shareloaded');
			})
	}
	
	Share.prototype._isVideo = function(an){
		//Detect if the annotation is a Open Video Annotation
		var an = an || {}
			rt = an.rangeTime,
			isVideo = (typeof an.media!='undefined' && an.media=='video'),
			hasContainer = (typeof an.target!='undefined' && typeof an.target.container!='undefined' ),
			isNumber = (typeof rt!='undefined' && !isNaN(parseFloat(rt.start)) && isFinite(rt.start) && !isNaN(parseFloat(rt.end)) && isFinite(rt.end));
		return (isVideo && hasContainer && isNumber);
	}
	
	Share.prototype.getParameterByName = function(name) {
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	};


	Share.prototype.updateViewer = function(field, annotation) {
		//if (annotation.media && annotation.media == 'video') {
		var self = this,
			field = $(field),
			ret = field.addClass('share-viewer-annotator').html(function() {
				var string;
				return self.buildHTML();
			});
		this.annotation = annotation;
		//Create the actions for the buttons
		this.buttonsActions(field[0],1); //1 is the method of the API that will be for share some annotation in the database
		return ret;
	};

	return Share;

})(Annotator.Plugin);

